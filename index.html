<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Navaraa Staking UI</title> <!--
  <meta name="viewport" content="width=device-width, initial-scale=1.0">.    --->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!---- connect for mobile version ---->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
    
    *{
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      text-decoration: none;
      border: none;
      outline: none;
      scroll-behavior: smooth;
    }
    
    
      /* ========== GLOBAL RESET ========== */
body {
  font-family: 'Poppins', sans-serif;
  background: #f5f6fa;       /* Light Background */
  color: #333333;            /* Dark Text */
}

/* ========== HEADER ========== */
.header {
  background: #1e1e2f;       /* Dark Header */
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  padding: 0.8rem 8%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
}

.logo-img {
  height: 60px;
  width: auto;
  border-radius: 6px;
}

/* ========== BUTTONS ========== */
.btn, .danger {
  font-size: 16px;
  padding: 10px 18px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.2s ease, transform 0.1s ease;
}

.btn {
  background: #4a90e2;       /* Primary Blue */
  color: #ffffff;
}
.btn:hover {
  background: #357abd;       /* Darker Blue */
  transform: translateY(-2px);
}

.danger {
  background: #e74c3c;       /* Red */
  color: #ffffff;
}
.danger:hover {
  background: #c0392b;       /* Dark Red */
  transform: translateY(-2px);
}

/* ========== MAIN CONTENT ========== */
.main-content {
  margin-top: 120px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.wallet-info .w-add {
  background: #ffffff;       /* White Box */
  padding: 14px 28px;
  border-radius: 10px;
  font-size: 18px;
  font-weight: 600;
  color: #444444;            /* Medium Dark Text */
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

.total-stake {
  margin-top: 30px;
  display: flex;
  gap: 20px;
  justify-content: center;
}

.stake-text, .stake-no {
  background: #ffffff;       /* White Box */
  padding: 14px 28px;
  border-radius: 10px;
  font-size: 18px;
  font-weight: 600;
  color: #444444;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

/* ========== CARDS ========== */
#stakeCards {
  margin-top: 40px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 25px;
  padding: 20px 8%;
}

.card {
  background: #ffffff;       /* White Card */
  color: #333333;            /* Dark Text */
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
}

.card-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 15px;
  border-bottom: 1px solid #eeeeee;
  padding-bottom: 8px;
}

.card p {
  margin: 8px 0;
  font-size: 15px;
  line-height: 1.6;
}

.token-name {
  margin-left: 4px;
  font-weight: 500;
  color: #666666;            /* Light Gray */
}

.card-actions {
  margin-top: 20px;
  display: flex;
  justify-content: space-between;
}
.card-actions button {
  flex: 1;
  margin: 0 5px;
}

    

        /*__________________SECTION 5 : Total stake count_____________________*/

    

  </style>
</head>
  <body>
  <!------------- h t m l   c o d e    h e r e ------->
    <!--- Section_1: header ( logo.png + logo text + connect wallet) ----->
      <header class="header">
        <div class="logo-container">
          <img src="logo.png" alt="Logo" class="logo-img" />
        </div>
         <button id="connectButton" class="btn">Connect Wallet</button>
      </header>
  <!----Section 2 : wallet address ---------->
    <div class="main-content" >
      <div class="wallet-info">
        <div class="w-add" id="wallet">"Not Connected"</div>
      </div>
    </div>
    <!----Section 3 : Total stake count ------>
      <div class="total-stake">
        <div class="stake-text">Total Stake:</div> 
        <div class="stake-no" id="stakeCount">-</div>
      </div>
    <!----Section 4 : User Stake Cards (dynamic) ------EXTRA---->
    <div id="stakeCards"></div>

    
  
<!---------------------J A V A S C R I P T-----S T A R T------------------------------->
  <script>
    const CONTRACT_ADDRESS = "0x9fd473975cecd4587d78eb71f4498dde778c4b83";

    const ABI = [
  "function stakeCount(address user) view returns (uint256)",
  "function pendingRewardForStake(address user, uint256 index) view returns (uint256)",
  "function getStake(address user, uint256 index) view returns (uint256 amount, uint256 startTime, uint256 claimed, bool principalWithdrawn, uint256 totalReward)",
  "function claimStakingRewards(uint256[] calldata indices)",
  "function withdrawPrincipal(uint256[] calldata indices)"
];
    
    let provider, signer, contract, userAddress;
    
    /***********Desktop+Mobile wallet connect ******/
    
async function connectWallet() {
  if (window.ethereum) {
    // ‚úÖ MetaMask (Desktop + Mobile)
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);

    // üîç Network check (Polygon only)
    const network = await provider.getNetwork();
    if (network.chainId !== 137) {
      alert("‚ö†Ô∏è Please switch to Polygon Mainnet (Chain ID 137) in your wallet.");
      return;
    }

  } else {
    // ‚úÖ Trust Wallet / Others via WalletConnect
    const wcProvider = new WalletConnectProvider.default({
      rpc: {
        137: "https://polygon-rpc.com"
      },
    });
    await wcProvider.enable();
    provider = new ethers.providers.Web3Provider(wcProvider);

    // üîç Check again
    const network = await provider.getNetwork();
    if (network.chainId !== 137) {
      alert("‚ö†Ô∏è Please switch to Polygon Mainnet (Chain ID 137).");
      return;
    }
  }

  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  document.getElementById("wallet").innerText = userAddress;
  const connectBtn = document.getElementById("connectButton");
  connectBtn.innerText = "Connected";
  connectBtn.disabled = true;
  connectBtn.style.background = "#2e7d32";
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  loadInfo();
}  

    /*__________________Extra_________________*/

async function loadInfo() {
  try {
    const count = await contract.stakeCount(userAddress);
    document.getElementById("stakeCount").innerText = count.toString();

    const stakeCardsContainer = document.getElementById("stakeCards");
    stakeCardsContainer.innerHTML = ""; // purane cards clear karo

    for (let i = 0; i < count; i++) {
      const pending = await contract.pendingRewardForStake(userAddress, i);
      const stakeInfo = await contract.getStake(userAddress, i);

      const amount = stakeInfo.amount;  
      const startDate = new Date(stakeInfo.startTime.toNumber() * 1000);
      const totalReward = stakeInfo.totalReward;

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3 class="card-title">Stake #${i}</h3>
        <p><b>Staked Amount:</b> ${ethers.utils.formatEther(amount)} Navaa</p>
        <p><b>Start Date:</b> ${startDate.toLocaleString()}</p>
        <p><b>Total Reward:</b> ${ethers.utils.formatEther(totalReward)} Navaa</p>
        <p><b>Pending Reward:</b>
        <span id="pending-${i}">${ethers.utils.formatEther(pending)}</span> 
        <span class="token-name">Navaa</span>
        </p>
        <div class="card-actions">
          <button class="btn claimBtn" data-index="${i}">Claim Reward</button>
          <button class="danger withdrawBtn" data-index="${i}">Withdraw Principal</button>
        </div>
      `;
      stakeCardsContainer.appendChild(card);

      // üîÑ Live update for Pending Reward
      let pendingLive = parseFloat(ethers.utils.formatEther(pending));
      const totalRewardNum = parseFloat(ethers.utils.formatEther(totalReward));

      // Example: maan lo fixed duration 30 din (apne contract ke hisaab se adjust karna)
      const duration = 30 * 24 * 60 * 60; 
      const rewardRatePerSecond = totalRewardNum / duration;

      setInterval(() => {
        pendingLive += rewardRatePerSecond;
        document.getElementById(`pending-${i}`).innerText = pendingLive.toFixed(6);
      }, 1000);
    }

    // Buttons ko activate karo
    document.querySelectorAll(".claimBtn").forEach(btn => {
      btn.onclick = () => claimReward(btn.dataset.index);
    });

    document.querySelectorAll(".withdrawBtn").forEach(btn => {
      btn.onclick = () => withdrawPrincipal(btn.dataset.index);
    });

  } catch (err) {
    console.error(err);
    alert("Error loading info: " + err.message);
  }
}

    ///////////////////////////////////////
    async function claimReward(index) {
  try {
    const tx = await contract.claimStakingRewards([index]);
    alert("Claiming stake #" + index + " ... Tx: " + tx.hash);
    await tx.wait();
    alert("Reward claimed for stake #" + index);
    loadInfo();
  } catch (err) {
    console.error(err);
    alert("Claim failed: " + err.message);
  }
}

async function withdrawPrincipal(index) {
  try {
    const tx = await contract.withdrawPrincipal([index]);
    alert("Withdrawing stake #" + index + " ... Tx: " + tx.hash);
    await tx.wait();
    alert("Principal withdrawn for stake #" + index);
    loadInfo();
  } catch (err) {
    console.error(err);
    alert("Withdraw failed: " + err.message);
  }
}
    
    
/*-------------------------------End Extra---------------------*/
    document.getElementById("connectButton").onclick = connectWallet;
  </script>
</body>
</html>

